<meta charset="utf-8">

<style type="text/css">
	.users {
		position: absolute;
		left: 0px;
		top: 0px;
	}
	.users #userzone{
		width: 200px;
		height: 400px;
		border: 1px solid #ddd;
		border-radius: 7px;
		overflow-y: scroll;
		background: #333;
		color: #fff;
	}
	.chat {
		position: absolute;
		left: 200px;
		top: 0px;
	}
	.chat #chatzone{
		width: 500px;
		height: 400px;
		border: 1px solid #ddd;
		border-radius: 7px;
		overflow-y: scroll;
		background: #333;
		color: #fff;
	}
</style>

<div class ="users">
	<div id="userzone" name="userzone">
		<ul id="username">
			<li id="user1">Usernames</li>
		</ul>
	</div>
</div>

<div class="chat">
	<div id="chatzone" name="chatzone">
		<ul id="chatmessage">
		</ul>
	</div>
	<input type="text" id="msg" style="width: 190px;" />
	<button id="send" onClick="sendthemessage()">Send</button>
	<input id="scroll" type="checkbox" /> scroll to bottom upon new message
</div>

<script>

  const socket = new WebSocket('ws://localhost:8080');
  username = "";
  howmany = 0;
  nickarray = [];

  socket.addEventListener('open', function (event) {
  	messagetosend = "connected... go ahead and chat with other people!"
  	addmessage();
  });

  socket.addEventListener('close', function(event) {
 	 messagetosend = "disconnected..."
 	 addmessage();
  });

  socket.addEventListener('error', function(event) {
  	messagetosend = "an error has occured!"
  	addmessage();
  });
  
  socket.addEventListener('message', function (event) 
  {
	if(event.data === "A user has Connected")
	{	
		return;
	}
	
	str = event.data;
	addusername();
	
	messagetosend = event.data;
	addmessage();
	
	const chat = document.getElementById("chatzone");
	const scroll = document.getElementById("scroll");
	if (scroll.checked === true && chat.scrollTop !== chat.scrollHeight) {
		chat.scrollTop = chat.scrollHeight;
	}
	
  });
 
  send.addEventListener("click", () => {
		sendthemessage();
  });

document.getElementById("msg").addEventListener("keydown", function(e) {
if (e.keyCode == 13) 
	{ 
		sendthemessage();
	}
}, false);

function usernamecheck(){
		const getname = prompt("Please enter your name", "");
		username = getname;
}

function sendthemessage(){
	if(/\S/.test(username) === true && /\S/.test(msg.value) === true)
	{
		const txt = msg.value;
		socket.send(username + ": " + txt);
		
		str = username;
		addusername();
		
		messagetosend = username + ": " + txt;
		addmessage();
		
		const chat = document.getElementById("chatzone");
		const scroll = document.getElementById("scroll");
		if (scroll.checked === true && chat.scrollTop !== chat.scrollHeight) {
			chat.scrollTop = chat.scrollHeight;
		}
		msg.value = "";
	}else if(/\S/.test(username) === false){
		usernamecheck();
	}
};
 
function addusername(){
		if(typeof userarray !== 'undefined' && userarray.length >= 1){
			userarray.push(str.split(": ",1));
			howmany = howmany + 1;
			nickname = userarray[howmany];
		}else{
			userarray = str.split(": ",1);
			nickname = userarray[0];
		}

		for (i = 0; i < nickarray.length; i++){
				console.log("nickarray: "+nickarray)
				console.log("nickarray[i]: "+nickarray[i])
				console.log("nickname: "+ nickname)
				console.log("--------" + i + "--------");
			if(nickarray[i] == nickname){
				return;
			}
		}
		
		const ul2 = document.getElementById("username");		
		const li2 = document.createElement("li");
		const children2 = ul2.children.length + 1
		li2.setAttribute("id", "user"+children2)
		li2.appendChild(document.createTextNode(nickname));
		ul2.appendChild(li2)			
		nickarray.push(nickname);
}

function addmessage(){
	const ul = document.getElementById("chatmessage");
	const li = document.createElement("li");
    const children = ul.children.length + 1
	li.setAttribute("id", "element"+children)
	li.appendChild(document.createTextNode(messagetosend));
	ul.appendChild(li)
}
</script>
