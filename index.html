<meta charset="utf-8">

<style type="text/css">
	.users {
		position: absolute;
		left: 0px;
		top: 0px;
	}
	.users #userzone{
		width: 200px;
		height: 400px;
		border: 1px solid #ddd;
		border-radius: 7px;
		overflow-y: scroll;
		background: #333;
		color: #fff;
	}
	.chat {
		position: absolute;
		left: 200px;
		top: 0px;
	}
	.chat #chatzone{
		width: 500px;
		height: 400px;
		border: 1px solid #ddd;
		border-radius: 7px;
		overflow-y: scroll;
		background: #333;
		color: #fff;
	}
</style>

<div class ="users">
	<div id="userzone" name="userzone">
		<ul id="username">
			<li id="user1">Usernames</li>
		</ul>
	</div>
</div>

<div class="chat">
	<div id="chatzone" name="chatzone">
		<ul id="chatmessage">
			<li id="element1">connected... go ahead and type with other people!</li>
		</ul>
	</div>
	<input type="text" id="msg" style="width: 190px;" />
	<button id="send" onClick="usernamecheck()">Send</button>
	<input id="scroll" type="checkbox" /> scroll to bottom upon new message
</div>

<script>

  // Create WebSocket connection.
  const socket = new WebSocket('ws://localhost:8080');
  username = "";
  howmany = 0;
  nickarray = [];
  // Connection opened
  socket.addEventListener('open', function (event) 
  {
    //socket.send('A user has Connected');
  });
  // Listen for messages
  socket.addEventListener('message', function (event) 
  {
    console.log('Message from server', event.data);
	if(event.data === "A user has Connected")
	{	
		return;
	}
	
	//add username
	str = event.data
	addusername();
	
	//add new message to the chatbox
	messagetosend = event.data;
	addmessage();
	
	//scroll if scroll is checked and not at bottom
	const chat = document.getElementById("chatzone");
	const scroll = document.getElementById("scroll");
	if (scroll.checked === true && chat.scrollTop !== chat.scrollHeight) {
		chat.scrollTop = chat.scrollHeight;
	}
	
  });
  

//send message when enter is pressed
document.getElementById("msg").addEventListener("keydown", function(e) {
if (e.keyCode == 13) 
	{ 
		usernamecheck();
		if (/\S/.test(username) === true) {
			sendthemessage();
		}
		msg.value = "";
	}
}, false);

function usernamecheck(){
	if (/\S/.test(username) === false) {
		const getname = prompt("Please enter your name", "");
		username = getname;
	}
}

function sendthemessage(){
	if(/\S/.test(msg.value) === true)
	{
		const txt = msg.value;
		socket.send(username + ": " + txt);
		
		//add username
		str = username;
		addusername();
		
		//add new message to the chatbox
		messagetosend = username + ": " + txt;
		addmessage();
		
		//scroll if scroll is checked and not at bottom
		const chat = document.getElementById("chatzone");
		const scroll = document.getElementById("scroll");
		if (scroll.checked === true && chat.scrollTop !== chat.scrollHeight) {
			chat.scrollTop = chat.scrollHeight;
		}
	}
};
 
function addusername(){
	if(typeof userarray !== 'undefined' && userarray.length >= 1){
		userarray.push(str.split(": ",1));
		howmany += 1;
		nickname = userarray[howmany];
	}else{
		userarray = str.split(": ",1);
		nickname = userarray[0];
	}
	
	if(!nickarray.includes(nickname)){
		const ul2 = document.getElementById("username");		
		const li2 = document.createElement("li");
		const children2 = ul2.children.length + 1
		li2.setAttribute("id", "user"+children2)
		li2.appendChild(document.createTextNode(nickname));
		ul2.appendChild(li2)			
		nickarray.push(nickname);
	}
}

function addmessage(){
	const ul = document.getElementById("chatmessage");
	const li = document.createElement("li");
    const children = ul.children.length + 1
	li.setAttribute("id", "element"+children)
	li.appendChild(document.createTextNode(messagetosend));
	ul.appendChild(li)
}

  //send message on click
  send.addEventListener("click", () => {
    sendthemessage();
	msg.value = "";
  });
  
</script>
